%\pagestyle{fancy}
\chapter{Methods}
\label{ch:Methods}
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

\section{IMU only}
\subsection{Calibration}
\todoin{Strucutre:
\begin{itemize}
    \item Problem: Measurements are in IMU frame, but we want them in car frame
    \item Solution p1: Rotate such that both z axes align (up)
    \item Solution p2:
\end{itemize}}

\dots IMU (device) frame $\mathcal{I}$ has to be aligned with the car frame $\mathcal{C}$.

\begin{equation}
    { }_{\mathcal{I}}^{\mathcal{C}} \mathbf{p}
\end{equation}
\begin{equation}
    { }_{\text{car}}^{\text{imu}} \mathbf{p}
\end{equation}
which means "p-$\mathcal{C} \text{ in } \mathcal{I}-\text{coordinates}$"

A rotation matrix ${ }_{\mathcal{C}}^{\mathcal{I}}\mathbf{M}$ that transforms the measurements ${}_{\mathcal{I}}\mathbf{p}$ from the IMU frame to the car frame
\begin{equation}
    { }_{\mathcal{C}}\mathbf{p} = { }_{\mathcal{C}}^{\mathcal{I}}\mathbf{M} {}_{\mathcal{I}}\mathbf{p} \quad \forall_{\mathcal{I}} \mathbf{p} \in \mathbb{R}^{3}
\end{equation}

According to Euler's rotation theorem, which says that any abritary rotation of a rigid body while holding one point (origin) fixed can be achieved by a rotation around a single fixed axis passing through the origin
The rotation axis is perpendicular to both axes
\begin{equation}
    \vb{j} = \frac{\vb{c}}{\norm{\vb{c}}}
\end{equation}
with
\begin{equation}
    \vb{c} = \vb{a}\cp\vb{b}
\end{equation}
and rotation angle
\begin{equation}
    \alpha = \arctan(\norm{\vb{c}}, \vb{d})
\end{equation}
with
\begin{equation}
    \vb{d} = \vb{a}\cdot\vb{b}
\end{equation}

During standstill, the only measurable acceleration should be the gravity acceleration.
As a first step, the coordinate frame of the IMU will be rotated in such way, that the gravity axis of the IMU frame aligns with the z axis of the car frame.
A vector $v1$ can be aligned with vector $v2$ using
\begin{equation}
    q = \frac{\hat{v_1}\hat{v_2}}{123}
\end{equation}
with
\begin{equation}
    \hat{v_1} = \frac{\vec{v_1}}{\left|\vec{v_1}\right|}
 \end{equation}
 being the unit vector

$$ax = \frac{g_\mathrm{imu}\cdot g_\mathrm{car}}{\lVert g_\mathrm{imu}\times g_\mathrm{car} \rVert}$$
and the needed rotation angle
$$\alpha = \arctan\left(\frac{\lVert g_\mathrm{imu}\times g_\mathrm{car}\rVert}{g_\mathrm{imu}\cdot g_\mathrm{car}}\right) $$
which then leads to the following quaternion $$q=[ax\cdot\sin(\frac{\alpha}{2}),\quad \cos(\frac{\alpha}{2})]$$

\missingfigure{Coordinate frame of car (standing on flat ground) and IMU}


\begin{figure}[htpb]
    \centering
	\begin{tikzpicture}[scale=1]
		% RAMP
        % Define/Calc ramp parameters
        % Ramp length
        \def\rl{10};
        % Ramp angle [deg]
        \def\ra{15};
        % Ramp height
        \def\rh{{tan(\ra)*\rl}};

		% Define the points
		\coordinate (A) at (0,0);
		\coordinate (B) at ($(A) + (\rl,0)$);
		\coordinate (C) at ($(B) + (0,\rh)$);
        % Draw and fill ramp
		\filldraw[draw=black, fill=lightgray!25] (A) -- (B) -- (C) -- cycle;
        % Label length and draw angle
        \path (A) -- (B) node [midway, below] {$d$}
		pic[draw, ->, angle radius=40pt,
		angle eccentricity=0.75, "$\alpha$"]{angle=B--A--C};
        % Label height
        \draw (B) -- (C) node [midway, right] {$h$};

        % CAR
        % Tilt whole car
        \begin{scope}[scale=0.7, xshift=\rl*0.5 cm, yshift=1.9 cm, rotate=\ra]

            % Car height
            \def\ch{2}
            % Car length
            \def\cl{5}
            % Car body height
            \def\bh{\ch*0.65}
            % Roof length
            \def\rl{\cl*0.6}
            % Roof height
            \def\rh{\ch*0.35}
            % Car tilt angle
            \def\ct{6}

            % Tilt body without wheels
            \begin{scope}[rotate=\ct, yshift=-0.2cm]
                % Anchor point is southwest
                \coordinate (b) at (0,0);
                % Offset to roof and wheels
                \coordinate (r) at ($(b) +(\cl*0.17,\ch*0.65)$);
                \coordinate (w) at ($(b) + (\cl*0.25,0)$);
                % Body
                \draw[black, fill=black!17, rounded corners=1.2ex, very thick]
                (b) -- ++(0,\bh) -- ++(\cl*1/5,0) --  ++(\cl*3/5,0) -- ++(\cl*1/5,-\bh*0.25)
                -- ++(0, -\bh*0.75) -- (b) -- cycle;
                % Roof
                \draw[very thick, rounded corners=0.5ex, fill=black!20!blue!20!white,thick]
                (r) -- ++(0.2*\rl,\rh) -- ++(0.5*\rl,0) -- ++(0.3*\rl,-\rh) -- (r);
				\draw[thick] (r)++(\rl*0.6,0) -- ++(0,\rh);

                % Car middle point
                \coordinate (m) at (\cl*0.5, \bh*0.5);
                \node at (m) {\textbullet};
                % Line parallel to body
                \draw (m) -- ++(7,0) coordinate (pb);
                % Line parallel to ramp
                \draw[rotate = -\ct] (m) -- ++(7,0) coordinate (pr);
                % Line parallel to ground
                \draw[rotate = -\ct-\ra] (m) -- ++(7,0) coordinate (pg);
                % Draw angles
                \path (pb) -- (pr)
                pic[draw, ->, angle radius=60pt, angle eccentricity=1.2, "$\alpha$"] {angle = pg--m--pr}
                pic[draw, ->, angle radius=80pt, angle eccentricity=1.1, "$\beta$"] {angle = pr--m--pb}
                pic[draw, ->, angle radius=100pt, angle eccentricity=1.1, "$\theta$"] {angle = pg--m--pb};
            \end{scope}

                % Wheels
                \draw[draw=black,fill=gray!50,thick] (w) circle (.5);
                \draw[draw=black,fill=gray!50,thick] (w) ++(\cl*0.55,0) circle (.5);
                % Inner wheels
                \draw[draw=black,fill=gray!80,semithick] (w) circle (.35);
                \draw[draw=black,fill=gray!80,semithick] (w) ++(\cl*0.55,0) circle (.35);
        \end{scope}
	\end{tikzpicture}
	\caption{Car driving on a ramp. Due to forward acceleration the car tilts back.}
\end{figure}

Complementary filter
\begin{equation}
	\theta = (1-\alpha)(\theta + gyrData\cdot dt) + \alpha(accData)
\end{equation}

\section{IMU + Odometer}
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

\section{LiDAR only}

\begin{figure}[htpb]
    % Distance for measurement line
    \def\dd{.4cm}
	\centering
	\begin{tikzpicture}[scale=1]
		% RAMP
        % Define/Calc ramp parameters
        % Ramp length
        \def\rl{5};
        % Ramp angle [deg]
        \def\ra{15};
        % Ramp height
        \def\rh{{tan(\ra)*\rl}};

		% Define the points
		\coordinate (A) at (0,0);
		\coordinate (B) at ($(A) + (\rl,0)$);
		\coordinate (C) at ($(B) + (0,\rh)$);
        % Draw and fill ramp
		\filldraw[draw=black, fill=lightgray!25] (A) -- (B) -- (C) -- cycle;
        % Draw angle
        \path (A) -- (B)
		pic[draw, ->, angle radius=40pt,
		angle eccentricity=0.75, "$\alpha$"]{angle=B--A--C};
		% Ground and helpers
		\coordinate (D) at ($(A) + (-10,0)$);
		\draw [thick] (D) -- (A) -- (C);

        % CAR
        \begin{scope}[scale=0.7]
            % Car height
            \def\ch{2}
            % Car length
            \def\cl{5}
            % Car body height
            \def\bh{\ch*0.65}
            % Roof length
            \def\rl{\cl*0.6}
            % Roof height
            \def\rh{\ch*0.35}
            % Car tilt angle
            \def\ct{6}
			% Anchor point is southwest
			\coordinate (b) at ($(D) + (0,0.5)$);
			% Offset to roof and wheels
			\coordinate (r) at ($(b) +(\cl*0.17,\ch*0.65)$);
			\coordinate (w) at ($(b) + (\cl*0.25,0)$);

			% Body
			\draw[black, fill=black!17, rounded corners=1.2ex, very thick]
			(b) -- ++(0,\bh) -- ++(\cl*1/5,0) --  ++(\cl*3/5,0) -- ++(\cl*1/5,-\bh*0.25)
			-- ++(0, -\bh*0.75) -- (b) -- cycle;
			% Roof
			\draw[very thick, rounded corners=0.5ex, fill=black!20!blue!20!white,thick]
			(r) -- ++(0.2*\rl,\rh) -- ++(0.5*\rl,0) -- ++(0.3*\rl,-\rh) -- (r);
			% \draw[thick] ($(r) + (\cl*0.5,\bh)$) -- ++(0,\rh);
			\draw[thick] (r)++(\rl*0.6,0) -- ++(0,\rh);

			% Wheels
			\draw[draw=black,fill=gray!50,thick] (w) circle (.5);
			\draw[draw=black,fill=gray!50,thick] (w) ++(\cl*0.55,0) circle (.5);
			% Inner wheels
			\draw[draw=black,fill=gray!80,semithick] (w) circle (.35);
			\draw[draw=black,fill=gray!80,semithick] (w) ++(\cl*0.55,0) circle (.35);

			% Lidar
			\draw[black, fill=red!50] ($(r) + (\cl*0.40,\rh)$) coordinate (le) arc(-10:180:0.4) --cycle;

			% Car middle point
			\coordinate (m) at (\cl*0.5, \bh*0.5);
			% Lidar middle point
			\coordinate (lm) at ($(le) + (-0.39,0.2)$);
            \filldraw[red] (lm) circle(.1);

			% Laser lines
			\draw[->,color=red,decorate,decoration={snake,amplitude=.2mm,segment length=1mm,post length=1mm}] (lm) -- (A);
			\draw[->,color=red,decorate,decoration={snake,amplitude=.2mm,segment length=1mm,post length=1mm}] (lm) -- ($(A)!0.5!(C)$);
        \end{scope}

        \dimline[extension start length=-\dd, extension end length=-\dd] {($(D)+(0,-\dd)$)}{($(A)+(0,-\dd)$)}{$d$};
        \dimline[extension start length=-\dd, extension end length=-\dd] {($(A)+(0,-\dd)$)}{($(B)+(0,-\dd)$)}{$l$};
        \dimline[extension start length=-\dd, extension end length=-\dd] {($(B)+(\dd,0)$)}{($(C)+(\dd,0)$)}{$h_\mathrm{r}$};
        \dimline[extension start length=\dd, extension end length=\dd+1.7cm] {($(D)+(-\dd,0)$)}{($(lm -| D)+(-\dd,0)$)}{$h$};
        % \draw (D) -- (lm -| D);
        % \dimline[extension start length=-\dd, extension end length=-\dd] {($(lm)+(\dd,0)$)}{($(C)+(\dd,0)$)}{$h_2$};
        % \dimline[extension start length=\dd, extension end length=\dd] {($(A)+(0,\dd)$)}{($(C)+(0,\dd)$)}{$d$};
	\end{tikzpicture}
	\caption{Tikz is hard}
\end{figure}

\section{All other fusion stuff}
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

\section{Validation Concept}
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.