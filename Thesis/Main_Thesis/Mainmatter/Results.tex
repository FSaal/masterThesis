%\pagestyle{fancy}
\chapter{Results}
\label{ch:Results}

\section{Evaluation concept}
\todoin{\begin{itemize}
		\item The straight ramp on floor -2 will be used as main example
		\item All plots will be only made for that ramp
		\item Except maybe for special edge cases (e.g. influence of braking on imu estimation)
		\item All the other ramps will be only evaluated using scores, displayed in tables
	\end{itemize}}
To prevent an overfitting of the model, it is important to have many test scenarios.
Six different ramps will be tested, some of which will be driven up and some down.
An additional recording without any ramp was made to test false positives.
As mentioned in \cref{ch:ExperimentalSetup}, the wheel odometer measurements are only available, when the motor output of the car is limited.
This means that recordings with the odometer data were only possible for the test cases, where the car is driving down or only halfway up.



\section{Ramp metering? (\glsentrytext{imu})}
To evaluate the performance of the different algorithms, a reference must be used.
The most accurate one available is the one produced by the \texttt{hdl\_graph\_slam}~\footnote{\url{https://github.com/koide3/hdl_graph_slam}} package.
This package is based on 3D graph slam and uses the \gls{lidar} data to estimate the position and orientation.
Because the \gls{lidar} only records at \SI{10}{\hertz} and the other sensors record from \SIrange{100}{400}{\hertz}, the estimate was upsampled using a Fourier method.\\
The goodness of the fit between the estimated road grade $\hat{y} = (\hat{y}_i, \dots, \hat{y}_n)^\intercal$ and the reference $y = (y_i, \dots, y_n)^\intercal$ can be described by the \gls{rmse}
\begin{equation}
	RMSE = \sqrt{\frac{1}{n}\sum_{i = 1}^n(\hat{y}_i - y_i)^2},
\end{equation}
which quantifies how much the predicted values differ from the reference value on average.
It is defined in the range $[0, \infty)$, with a value of 0 indicating a perfect fit.
Furthermore, the coefficient of determination $R^2$ is used
\begin{equation}
	R^2 = 1 - \frac{\sum\limits_{i = 1}^n(\hat{y}_i - y_i)^2}{\sum\limits_{i = 1}^n(\hat{y}_i - \overline{y})^2},
\end{equation}
where $\overline{y}$ indicates the mean of the reference.
The goodness of the fit is described in the range from 0 to 1, where 1 describes a perfect fit.\\
Different recordings of different ramps were made, but the results will be discussed on only two test drives.
In the first drive the car was accelerated from stand still and drove up ramp A \todo{Picture and label of every ramp in setup section} about half-way up.
As explained in ?, the ramp could not be driven completely, due to the need of the odometer readings, which are only available when the motor output is limited.
\begin{figure}[htbp]
	\centering
	\includegraphics[width=.9\linewidth]{imu_raw_angle.pdf}
	\caption[Raw]{Pitch angle calculated from the raw accelerometer and gyroscope measurements}
	\label{fig:imu_raw_angle}
\end{figure}
The result of using only the raw measurements of the \gls{imu} for the pitch calculation is shown in \cref{fig:imu_raw_angle}.
The accelerometer is very noisy and is easily influenced by accelerations other than gravity, which can be seen at \SIrange{2}{4}{\second}, where the car started driving.
The gyroscope on the other hand provides good short-term accuracy and is not influenced by other accelerations, but is slowly drifting over time.\\
\iimprov{Show another plot of a longer drive, where drift is even more apparent}
The gravity method tries to overcome the problem of the accelerometer of also detecting other accelerations than gravity, by subtracting the car's acceleration from the accelerometer measurement.
The car's acceleration $\vb{a}_\mathrm{odom,x} $ was calculated by calculating the derivate of the low-pass filtered car velocity $v_\mathrm{car} $, which was calculated from the wheel speed measurements according to REF.
Figure \ref{fig:imu_odometer_acc} shows the (low-pass filtered) acceleration measured by the \gls{imu} along the x-axis and the (low-pass filtered) car's acceleration.
$\vb{a}_\mathrm{grav,x} $ is the acceleration measured by the \gls{imu} from which the car acceleration $\vb{a}_\mathrm{odom,x} $ was subtracted.
It can be seen, that especially at the beginning of the ramp (\SIrange{21}{23}{\second}) the gravity method shows it advantages.
The deceleration before entering the ramp is measured by both sensors and thus cancels out each other.
The same can be seen in the initial acceleration phase, where the car starts to drive from still stand (\SIrange[]{2}{4}{\second}).
Although both sensor are synchronized in time, the \gls{imu} senses the acceleration earlier than the wheel speed sensors which leads to a slight pike.
This could be due to the wheel speed sensors having a certain velocity threshold, below which they do not pick up any changes.
Other reasons for the difference could be, that other forces than the one from the car are present, e.g. from the suspension of the car or vibrations due to the road quality, which were not taken into account.
Also the approximations made by calculating the finite difference of the car velocity to get the car acceleration have a negative influence on the result.
\itodo{Either here or in methods: Describe problem with deriv car velocity $\to$ filtering beforehand was necessary}
\begin{figure}[htbp]
	\centering
	\includegraphics[width=.9\linewidth]{imu_odometer_acc.pdf}
	\caption[Acceleration from \gls{imu} and odometer]{Measured acceleration in x-direction by the \gls{imu} and acceleration derived from the wheel speed measurements and the difference between both}
	\label{fig:imu_odometer_acc}
\end{figure}
The resulting angle from the acceleration can be seen in \cref{fig:imu_odometer_angle}.
The reference is taken from the orientation estimation of the \texttt{hdl\_graph\_slam}, which uses the \gls{lidar} data.
It can be seen that the gravity method improves the estimation accuracy significantly, compared to when only using the accelerometer data.
Especially the angle at the start and on the ramp is more accurately described when adding the odometer data to the accelerometer data for the calculation.
But it can also be seen that the time synchronization between both signals is vital, as seen in during the initial acceleration phase.
\begin{figure}[htbp]
	\centering
	\includegraphics[width=.9\linewidth]{imu_odometer_angle.pdf}
	\caption[Gravity method]{The road grade estimation using only the accelerometer compared to the gravity method, which additionally uses the wheel speed measurements}
	\label{fig:imu_odometer_angle}
\end{figure}
Another way to improve the estimation is using a complementary filter, as shown in \cref{fig:imu_raw_compl_angle}.
The complementary filter uses the estimation of the gyroscope measurements and corrects them using the accelerometer measurements to prevent drift.
It can be seen that the estimation using the complementary filter closely follows the reference except for the .. between the two ramps.
Also it has no offset at the end, unlike the estimation from the gyroscope data.\\
Other methods of the same ride are shown in \cref{fig:imu_grav_compl_angle}.
The gravity method reduces the spikes of the raw accelerometer estimation, but introduces some new errors due to the odometer readings being slightly shifted in time regarding to the accelerometer readings.
SOMETHING MORE
\begin{figure}[htb]
	\centering
	\begin{subfigure}{1\textwidth}
		\centering
		\includegraphics[width=0.9\linewidth]{imu_raw_compl_angle.pdf}
		\caption{Complementary filter}
		\label{fig:imu_raw_compl_angle}
	\end{subfigure}
	
	% \bigskip
	\begin{subfigure}{1\textwidth}
		\centering
		\includegraphics[width=0.9\linewidth]{imu_grav_compl_angle.pdf}
		\caption{Something other ($\theta_\mathrm{compl, grav}$ is the same as compl and $\theta_\mathrm{grav}$ is just filtered acc)}
		\label{fig:imu_grav_compl_angle}
	\end{subfigure}
	\caption{This bag clearly shows the drift of the gyro, but lacks odometer measurements}
\end{figure}
\missingfigure{Plot of different compl gains}
The measuring of the length of the ramp works well when the odometer readings are available.
The car velocity can then be integrated to get the travelled distance along the x-axis.
Without the odometer data it is more difficult, but still possible by using the accelerometer data.
By integrating the accelerometer data ... the velocity and another integration leads to the travelled distance.

\missingfigure{Plot of problem of distance estimation using only accelerometer (initial acc is bad)}
\todoin{\begin{itemize}
		\item Think of better way to split test drives (e.g. up, down and long and short)
		\item Tune parameters
		\item Ignore acc odom if no odom has been recorded
		\item Add distance measurement (for full drives)
		\item Add angle estimate (final estimate)
		\item Possible add delay for acc odom and compl methods (due to lowpass filtering)
	\end{itemize}}

\begin{table}[htbp]
	\centering
	\caption{Performance measures up ZED \gls{imu}}
	\label{tab:eval_table_imu_up}
	\begin{tabular}[t]{ccccccc}
		\toprule
		\textbf{Properties}       & \multicolumn{3}{c}{\textbf{Ramp A}} & \multicolumn{3}{c}{\textbf{Ramp B}}                                                                    \\
		\midrule
		Mean(v)                   & \multicolumn{3}{c}{5}               & \multicolumn{3}{c}{5}                                                                                  \\
		Max(v)                    & \multicolumn{3}{c}{7}               & \multicolumn{3}{c}{3}                                                                                  \\
		Angle                     & \multicolumn{3}{c}{7}               & \multicolumn{3}{c}{3}                                                                                  \\
		\hline
		\textbf{Method}           & \textbf{RMSE}                       & $\mathbf{R^2}$                      & \textbf{Angle} & \textbf{RMSE} & $\mathbf{R^2}$ & \textbf{Angle} \\
		\cmidrule(lr){2-4}   \cmidrule(lr){5-7}
		Accelerometer             & 0.9478                              & 0.6508                              & 7.74           & 0.6497        & 0.7872         & 6.93           \\
		Gyroscope                 & 0.8544                              & 0.7996                              & 4.78           & 0.7910        & 0.7797         & 4.34           \\
		Acceleration method       & 0.4422                              & 0.9391                              & 7.95           & 0.3499        & 0.9555         & 7.06           \\
		Complementary filter      & 0.6693                              & 0.8731                              & 4.96           & 0.4514        & 0.9307         & 4.92           \\
		Complementary filter grav & 0.4113                              & 0.9619                              & 6.54           & 0.2786        & 0.9744         & 6.55           \\
		\bottomrule
	\end{tabular}
\end{table}
\begin{table}[htbp]
	\centering
	\caption{Performance measures down ZED \gls{imu}}
	\label{tab:eval_table_imu_down}
	\begin{tabular}[t]{ccccccc}
		\toprule
		\textbf{Properties}       & \multicolumn{3}{c}{\textbf{Ramp C}} & \multicolumn{3}{c}{\textbf{Ramp A}}                                                                    \\
		\midrule
		Mean(v)                   & \multicolumn{3}{c}{5}               & \multicolumn{3}{c}{5}                                                                                  \\
		Max(v)                    & \multicolumn{3}{c}{7}               & \multicolumn{3}{c}{3}                                                                                  \\
		Angle                     & \multicolumn{3}{c}{7}               & \multicolumn{3}{c}{3}                                                                                  \\
		\hline
		\textbf{Method}           & \textbf{RMSE}                       & $\mathbf{R^2}$                      & \textbf{Angle} & \textbf{RMSE} & $\mathbf{R^2}$ & \textbf{Angle} \\
		\cmidrule(lr){2-4}   \cmidrule(lr){5-7}
		Accelerometer             & 0.9478                              & 0.6508                              & 7.74           & 0.6497        & 0.7872         & 6.93           \\
		Gyroscope                 & 0.8544                              & 0.7996                              & 4.78           & 0.7910        & 0.7797         & 4.34           \\
		Acceleration method       & 0.4422                              & 0.9391                              & 7.95           & 0.3499        & 0.9555         & 7.06           \\
		Complementary filter      & 0.6693                              & 0.8731                              & 4.96           & 0.4514        & 0.9307         & 4.92           \\
		Complementary filter grav & 0.4113                              & 0.9619                              & 6.54           & 0.2786        & 0.9744         & 6.55           \\
		\bottomrule
	\end{tabular}
\end{table}
\todoin{\begin{itemize}
		\item Plots of (all only for one ramp)...
		\item Acceleration from \gls{imu} and odometer (already filtered)
		\item Angle estimation using only lin acc, ang vel
		\item Angle estimation comparing different sophisticated methods (complementary, gravity etc.)
		\item Plot comparing angle estimation using the different \gls{imu}s
	\end{itemize}}




\section{Ramp detection (\glsentrytext{lidar} and camera)}
rmse[] = distance, angle and width
For the evaluation of the \gls{lidar} performance the \texttt{hdl\_graph\_slam} package was used again.
It ... the position of the car and also a static point cloud map of the environment.
The ramp region was then manually ... and using the position ... the true distance to the ramp could be calculated.
The estimated width and angle of the ramp are being compared to a measured value.
Furthermore the detection rate was evaluated.
A true positive (successfull detection) was ..., when at least 50\% of the detected points lie inside the ramp region.
Analogously, a false positive is achieved, when less than 50\% of the detected points lie inside the ramp region.
An example of the pointcloud map generated by the \texttt{hdl\_graph\_slam} package is shown in \cref{fig:pcd_rviz}.
It can be seen that the \gls{lidar}
The ramp region was marked by hand and is used as reference.
\begin{figure}[htbp]
	\centering
	\includegraphics[width=1\linewidth]{pcd_rviz.png}
	\caption{Screenshot of the generated point cloud map generated by the \texttt{hdl\_graph\_slam} package. The ramp is fat}
	\label{fig:pcd_rviz}
\end{figure}
\begin{table}[htbp]
	\centering
	\caption{Performance evaluation}
	\label{tab:eval_table_lidar}
	\begin{tabular}[t]{cccccccc}
		\toprule
		\textbf{Structure} & \textbf{Distance}        & \textbf{Frames} & \textbf{TP} & \textbf{FP} & \textbf{rmse1}    & \textbf{rmse2}     & \textbf{rmse3}    \\
		\midrule
		uc                 & \SIrange{0}{5}{\metre}   & 62              & 100.00\%    & 0.00\%      & \SI{0.75}{\metre} & \SI{0.61}{\degree} & \SI{0.75}{\metre} \\
		uc                 & \SIrange{5}{10}{\metre}  & 62              & 100.00\%    & 0.00\%      & \SI{0.84}{\metre} & \SI{0.68}{\degree} & \SI{0.84}{\metre} \\
		uc                 & \SIrange{10}{15}{\metre} & 59              & 100.00\%    & 0.00\%      & \SI{0.89}{\metre} & \SI{0.60}{\degree} & \SI{0.89}{\metre} \\
		uc                 & \SIrange{15}{20}{\metre} & 61              & 97.92\%     & 2.08\%      & \SI{2.75}{\metre} & \SI{0.95}{\degree} & \SI{2.75}{\metre} \\
		uc                 & \SIrange{20}{25}{\metre} & 61              & 97.83\%     & 2.17\%      & \SI{3.69}{\metre} & \SI{0.94}{\degree} & \SI{3.69}{\metre} \\
		uc                 & \SIrange{25}{30}{\metre} & 59              & 42.75\%     & 0.00\%      & \SI{2.36}{\metre} & \SI{2.22}{\degree} & \SI{2.36}{\metre} \\
		us                 & \SIrange{0}{5}{\metre}   & 162             & 83.33\%     & 6.67\%      & \SI{3.83}{\metre} & \SI{0.85}{\degree} & \SI{3.83}{\metre} \\
		us                 & \SIrange{5}{10}{\metre}  & 149             & 83.33\%     & 0.00\%      & \SI{0.75}{\metre} & \SI{0.41}{\degree} & \SI{0.75}{\metre} \\
		us                 & \SIrange{10}{15}{\metre} & 144             & 100.00\%    & 0.00\%      & \SI{0.76}{\metre} & \SI{0.37}{\degree} & \SI{0.76}{\metre} \\
		us                 & \SIrange{15}{20}{\metre} & 150             & 87.41\%     & 0.74\%      & \SI{1.38}{\metre} & \SI{0.52}{\degree} & \SI{1.38}{\metre} \\
		us                 & \SIrange{20}{25}{\metre} & 169             & 79.38\%     & 0.69\%      & \SI{5.62}{\metre} & \SI{1.22}{\degree} & \SI{5.62}{\metre} \\
		us                 & \SIrange{25}{30}{\metre} & 78              & 43.42\%     & 0.00\%      & \SI{1.73}{\metre} & \SI{1.65}{\degree} & \SI{1.73}{\metre} \\
		\bottomrule
	\end{tabular}
\end{table}

\itodo{Make new recordings of level -2 ramps, approaching at different (e.g. 0, 15, 30, 45) angles}

\todo[inline, caption={2do}, color=green!40]{
	\begin{minipage}{\textwidth-4pt}
		\begin{itemize}
			\item Should structure be only one ramp (and direction) or should it include multiple?
			\item How to choose distance interval?
			\item What about offset angle?
			\item What about estimated distance, angle, width and length?
			\item What is a true positive? (E.g. some detected points lie in region, or at least $x$\% lie in region, or less than $y$\% points lie outside\dots)
			\item Are number of frames important?
			\item I've done multiple recordings of e.g. straight ramp on -2 floor, but only one of the ones on floor -1, how to handle?
		\end{itemize}
	\end{minipage}
}
\isug{Anzahl Fahrten als Spalte}
\isug{Subcategories rampentyp}
An visualization of the detection algorithm can be seen in \cref{fig:points_projection}.
The point cloud generated by the \gls{lidar} is projected onto to the camera image.
The quality of the projection depends on the accuracy of the measured translation and orientation difference between both sensors.
It can be seen that it is not perfect, e.g. the points do not quite match the camera image at the left pillar or the pipe on the ceiling.
Nonetheless it gives a good indication of what the \gls{lidar} actually sees.
The green points were identified as part of the ramp by the algorithm.
It fits the actual ramp very well...
It can be seen that the resolution at ground level and at the start of the ramp is worse.
TALK ABOUT IMAGE LEGEND
....
\begin{figure}[htbp]
	\centering
	\includegraphics[width=1\linewidth]{points_projection.pdf}
	\caption{Lidar points projected into the camera image. The green points were identified as part of a ramp.}
	\label{fig:points_projection}
\end{figure}
The estimated ramp properties and distance to the ramp for an exemplary ride are shown in \cref{fig:lidar_eval}.
In \cref{fig:lidar_distance_eval} the estimated distance is shown in comparison to the ... distance provided .... \texttt{hdl\_graph\_slam} package.
The error reduces when the car is closer to the ramp.
Interestingly the value of the estimated distance seems to hold itself for several m.
This is most probably due to the vertical resolution of the \gls{lidar} and more .... about the ... .
Because the vertical resolution is not linear, the most lines fall in the middle?
Hence, only few lines fall into the region at the start of the ramp.
The distance to the ramp is calculated by measuring the distance from the car to the $n$ closest points which have been identified as part of the ramp.
Therefore, the distance can only be updated if a line which has previously hit the ground now hits the ramp.
...
Fig. \ref{fig:lidar_angle_eval} shows the difference between the estimated angle and the HOW measured angle.
It can be seen that the estimation varies by about \ang{1} if the distance is less than \SI{20}{\metre}.
The angle is almost exclusively underestimated (OR OVER?), which could be due to the fact that the measurement was wrong.
Blabla in \ref{fig:lidar_width_eval}.
The error is very small compared to the tracking error.
Because the horizontal resolution is better.
\begin{figure}[htb]
	\centering
	\begin{subfigure}{1\textwidth}
		\centering
		\includegraphics[width=0.7\linewidth]{lidar_distance_eval.pdf}
		\caption{caption}
		\label{fig:lidar_distance_eval}
	\end{subfigure}
	
	\begin{subfigure}{1\textwidth}
		\centering
		\includegraphics[width=0.7\linewidth]{lidar_angle_eval.pdf}
		\caption{caption}
		\label{fig:lidar_angle_eval}
	\end{subfigure}
	
	\begin{subfigure}{1\textwidth}
		\centering
		\includegraphics[width=0.7\linewidth]{lidar_width_eval.pdf}
		\caption{caption}
		\label{fig:lidar_width_eval}
	\end{subfigure}
	\caption{Is subfigure better than separate?}
	\label{fig:lidar_eval}
\end{figure}

\begin{figure}[htbp]
	\centering
	\includegraphics[width=1\linewidth]{camera_detection_compare}
	\caption{Machine learning}
	\label{fig:camera_detection_compare}
\end{figure}